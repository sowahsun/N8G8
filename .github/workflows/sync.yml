name: N8G8 - Dual Engine Sync (FM Pro & FongMi)
on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©å‡Œæ™¨ 00:00 è‡ªåŠ¨å·¡æ£€
  workflow_dispatch:      # å…è®¸éšæ—¶åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘

jobs:
  # -------------------------------------------------------------------
  # ä»»åŠ¡ 1ï¼šFongMi å½±è§†åŒæ­¥ (å…ˆè·‘è¿™ä¸ªï¼Œè®©å®ƒå«åº•)
  # -------------------------------------------------------------------
  fongmi_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Instant Sync FongMi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: "sowahsun/N8G8"
          PREFIX: "FongMi-v"
        run: |
          echo "ğŸ” æ­£åœ¨è¯»å– FongMi ç›®å½•æ–‡ä»¶..."
          # è·å– apk æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å†…å®¹
          contents=$(gh api repos/FongMi/Release/contents/apk?ref=fongmi)
          
          # å¯»æ‰¾ leanback.json ä»¥æå–ç‰ˆæœ¬å·
          json_url=$(echo "$contents" | jq -r '.[] | select(.name=="leanback.json") | .download_url')
          
          if [ -z "$json_url" ] || [ "$json_url" == "null" ]; then
            echo "âŒ æ‰¾ä¸åˆ° leanback.jsonï¼Œæ— æ³•è·å–ç‰ˆæœ¬å·ã€‚"
            exit 0
          fi
          
          echo "ğŸ“„ æ­£åœ¨è§£æ leanback.json..."
          json_data=$(curl -sL "$json_url")
          version=$(echo "$json_data" | jq -r '.name')
          
          if [ -z "$version" ] || [ "$version" == "null" ]; then
            echo "âŒ æ— æ³•è§£æç‰ˆæœ¬å·ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi
          
          my_tag="${PREFIX}${version}"
          
          if gh release view "$my_tag" -R "$TARGET_REPO" >/dev/null 2>&1; then
            echo "âœ… FongMi ç‰ˆæœ¬ $my_tag å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
            exit 0
          fi
          
          echo "ğŸš€ å‘ç° FongMi æ–°ç‰ˆæœ¬: $version"
          # æå–æ›´æ–°æ—¥å¿—å¹¶ä¿å­˜åˆ°æ–‡æœ¬ï¼ˆé¿å…æ¢è¡Œç¬¦å¯¼è‡´å‘½ä»¤é”™è¯¯ï¼‰ï¼Œå¹¶åŠ ä¸Šæ¢è¡Œå‡†å¤‡è¿½åŠ  MD5
          echo "$json_data" | jq -r '.desc // "FongMi è‡ªåŠ¨åŒæ­¥æ›´æ–°"' > fongmi_notes.txt
          echo -e "\n### æ–‡ä»¶æ ¡éªŒ (MD5)" >> fongmi_notes.txt
          
          # åˆ›å»º Release (æ­¤æ—¶è¯´æ˜é‡Œè¿˜æ²¡æœ‰ MD5)
          gh release create "$my_tag" -R "$TARGET_REPO" --title "FongMi å½±è§†: $version" --notes-file fongmi_notes.txt
          
          # ç­›é€‰å‡ºæ‰€æœ‰çš„ apk æ–‡ä»¶è¿›è¡Œä¸‹è½½å’Œä¸Šä¼ 
          apk_urls=$(echo "$contents" | jq -r '.[] | select(.name | endswith(".apk")) | .download_url')
          for url in $apk_urls; do
            orig_name=$(basename "$url")
            echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ $orig_name..."
            curl -sL -o "$orig_name" "$url"
            
            # --- æ–°å¢ï¼šè®¡ç®— MD5 å¹¶è¿½åŠ åˆ°è¯´æ˜æ–‡ä»¶ ---
            echo "ğŸ§® æ­£åœ¨è®¡ç®— $orig_name çš„ MD5..."
            file_md5=$(md5sum "$orig_name" | awk '{print $1}')
            echo "- \`$orig_name\` MD5: \`$file_md5\`" >> fongmi_notes.txt
            # ------------------------------------
            
            echo "â¬†ï¸ æ­£åœ¨ä¸Šä¼  $orig_name..."
            gh release upload "$my_tag" "$orig_name" --clobber -R "$TARGET_REPO"
            rm -f "$orig_name"
          done
          
          # --- æ–°å¢ï¼šä¸Šä¼ å®Œæ‰€æœ‰ APK åï¼Œæ›´æ–° Release é¡µé¢å±•ç¤º MD5 ---
          echo "ğŸ“ æ­£åœ¨æ›´æ–° Release è¯´æ˜å±•ç¤º MD5..."
          gh release edit "$my_tag" -R "$TARGET_REPO" --notes-file fongmi_notes.txt

  # -------------------------------------------------------------------
  # ä»»åŠ¡ 2ï¼šFMApp å¢é‡åŒæ­¥ (ç²¾å‡†ç­›é€‰ PRO ç‰ˆï¼Œå‹è½´å‡ºåœº)
  # -------------------------------------------------------------------
  fmapp_pro_sync:
    needs: fongmi_sync  # ã€æ ¸å¿ƒä¿®æ”¹ç‚¹ã€‘å¼ºåˆ¶ç­‰å¾… fongmi_sync ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Instant Sync FMApp Pro
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: "sowahsun/N8G8"
          SOURCE_REPO: "lystv/fmapp"
          PREFIX: "FM-"
        run: |
          echo "ğŸ” æ­£åœ¨è·å– $SOURCE_REPO çš„æœ€æ–° PRO ç‰ˆæœ¬..."
          latest_rel=$(gh api repos/$SOURCE_REPO/releases | jq -c '[.[] | select(.tag_name | ascii_downcase | contains("pro"))][0]')
          
          if [ "$latest_rel" == "null" ] || [ -z "$latest_rel" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ…å« pro çš„æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi

          raw_tag=$(echo "$latest_rel" | jq -r '.tag_name')
          my_tag="${PREFIX}${raw_tag}"
          
          if gh release view "$my_tag" -R "$TARGET_REPO" >/dev/null 2>&1; then
            echo "âœ… FMApp ç‰ˆæœ¬ $my_tag å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
            exit 0
          fi

          echo "ğŸš€ å‘ç° FMApp æ–°ç‰ˆæœ¬: $raw_tag"
          title=$(echo "$latest_rel" | jq -r '.name // "New FM Release"')
          echo "$latest_rel" | jq -r '.body // "Incremental Update"' > release_notes.txt
          echo -e "\n### æ–‡ä»¶æ ¡éªŒ (MD5)" >> release_notes.txt

          # åˆ›å»º Release (æ­¤æ—¶è¯´æ˜é‡Œè¿˜æ²¡æœ‰ MD5)
          gh release create "$my_tag" -R "$TARGET_REPO" --title "FMApp: $title" --notes-file release_notes.txt

          assets=$(echo "$latest_rel" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          for url in $assets; do
            orig_name=$(basename "$url")
            echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ $orig_name..."
            curl -L -o "$orig_name" "$url"
            
            # --- æ–°å¢ï¼šè®¡ç®— MD5 å¹¶è¿½åŠ åˆ°è¯´æ˜æ–‡ä»¶ ---
            echo "ğŸ§® æ­£åœ¨è®¡ç®— $orig_name çš„ MD5..."
            file_md5=$(md5sum "$orig_name" | awk '{print $1}')
            echo "- \`$orig_name\` MD5: \`$file_md5\`" >> release_notes.txt
            # ------------------------------------
            
            echo "â¬†ï¸ æ­£åœ¨ä¸Šä¼  $orig_name..."
            gh release upload "$my_tag" "$orig_name" --clobber -R "$TARGET_REPO"
            rm -f "$orig_name"
          done
          
          # --- æ–°å¢ï¼šä¸Šä¼ å®Œæ‰€æœ‰ APK åï¼Œæ›´æ–° Release é¡µé¢å±•ç¤º MD5 ---
          echo "ğŸ“ æ­£åœ¨æ›´æ–° Release è¯´æ˜å±•ç¤º MD5..."
          gh release edit "$my_tag" -R "$TARGET_REPO" --notes-file release_notes.txt
