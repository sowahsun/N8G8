name: Full History Release Sync
on:
  workflow_dispatch: # 手动触发运行

jobs:
  clone_all:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone All Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "lystv/fmapp"
        run: |
          # 1. 获取原作者所有 Release 的 Tag 列表
          tags=$(gh api repos/$UPSTREAM/releases --jq '.[].tag_name')

          for tag in $tags; do
            echo "-----------------------------------"
            echo "正在处理版本: $tag ..."
            
            # 检查自己仓库是否已存在该 Release，存在则跳过
            if gh release view "$tag" >/dev/null 2>&1; then
              echo "跳过：$tag 已存在。"
              continue
            fi

            # 2. 获取该 Release 的详情
            release_info=$(gh api repos/$UPSTREAM/releases/tags/$tag)
            title=$(echo "$release_info" | jq -r '.name // "No Title"')
            body=$(echo "$release_info" | jq -r '.body // "No Description"')

            # 3. 创建 Release 壳子
            gh release create "$tag" --title "$title" --notes "$body"

            # 4. 下载、洗白重命名、上传
            assets=$(echo "$release_info" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
            
            for url in $assets; do
              orig_name=$(basename "$url")
              echo "正在中转文件: $orig_name"
              curl -L -o "$orig_name" "$url"
              
              # 洗白重命名逻辑
              if [[ "$orig_name" == *"mobile"* ]]; then
                target_name="fmapp_mobile.apk"
              else
                target_name="fmapp_tv.apk"
              fi
              
              # 上传原名和洗白名
              gh release upload "$tag" "$orig_name" --clobber
              mv "$orig_name" "$target_name"
              gh release upload "$tag" "$target_name" --clobber
              
              rm -f "$target_name"
            done
          done
