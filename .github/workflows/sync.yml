name: Incremental Stable Sync
on:
  schedule:
    - cron: '0 */23 * * *' # 每 23 小时巡检一次
  workflow_dispatch:      # 允许手动触发

jobs:
  sync_latest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync New Version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "lystv/fmapp"
        run: |
          # 1. 获取原作者最新的一个 Release
          latest_release=$(gh api repos/$UPSTREAM/releases/latest)
          tag=$(echo "$latest_release" | jq -r '.tag_name')
          
          # 2. 如果你的仓库里已经有这个 Tag 了，直接收工
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "当前已是最新版 ($tag)，无需同步。"
            exit 0
          fi

          # 3. 发现新版，开始“洗白”搬运
          echo "发现新版 $tag，准备搬运..."
          assets=$(echo "$latest_release" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          for url in $assets; do
            orig_name=$(basename "$url")
            curl -L -o "$orig_name" "$url"
            
            # 统一命名逻辑
            if [[ "$orig_name" == *"mobile"* ]]; then
              target_name="fmapp_mobile.apk"
            else
              target_name="fmapp_tv.apk"
            fi
            
            mv "$orig_name" "$target_name"
          done

          # 4. 创建发布并上传固定命名的 APK
          gh release create "$tag" --title "Stable Sync $tag" --notes "自动同步自 $UPSTREAM"
          [ -f fmapp_tv.apk ] && gh release upload "$tag" fmapp_tv.apk --clobber
          [ -f fmapp_mobile.apk ] && gh release upload "$tag" fmapp_mobile.apk --clobber
